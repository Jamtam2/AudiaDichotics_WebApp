
<!-- Audio player for WAV files ONLY 
 Dual audio player - two players, one for left and right, appearing as only one in the view-->
<div id="dichotic-player" class="audio-player">
  <audio id="left-player" style="display: block;">
    <source id="left-source" src="<%= url_for(controller: 'audio_files', action: 'play_left') %>" type="audio/wav">
  </audio>
  <audio id="right-player" style="display: block;">
    <source id="right-source" src="<%= url_for(controller: 'audio_files', action: 'play_right') %>" type="audio/wav">
  </audio>
  <button id="play-pause">Play</button>
  <input type="range" id="volume" min="0" max="1" step="0.1" value="1">
  <span id="current-time">0:00</span> / <span id="duration">0:00</span>
</div>

<!-- Forms for adjusting audio decibel levels -->
<!-- Form for adjusting both channels -->
<h3>Adjust Both Channels</h3>
<%= form_with(url: adjust_audio_files_path, method: :post, local: false, class: 'adjust-form') do |form| %>
  <%= form.number_field :decibel_change, step: 0.1, placeholder: 'Enter decibel change' %>
  <%= form.submit 'Change Both Channels' %>
<% end %>

<!-- Form for adjusting left ear channel -->
<h3>Adjust Left Channel</h3>
<%= form_with(url: adjust_audio_files_path, method: :post, local: false, class: 'adjust-form') do |form| %>
  <%= form.hidden_field :channel, value: 'left' %>
  <%= form.number_field :decibel_change, step: 0.1, placeholder: 'Enter decibel change' %>
  <%= form.submit 'Change Left Channel' %>
<% end %>

<!-- Form for adjusting right ear channel -->
<h3>Adjust Right Channel</h3>
<%= form_with(url: adjust_audio_files_path, method: :post, local: false, class: 'adjust-form') do |form| %>
  <%= form.hidden_field :channel, value: 'right' %>
  <%= form.number_field :decibel_change, step: 0.1, placeholder: 'Enter decibel change' %>
  <%= form.submit 'Change Right Channel' %>
<% end %>

<!-- Div for displaying audio analysis results (this is for debug, probably hide of real pages, or convert to soemthing we want to show them for 'haptic' feedback)-->
<div id="analysis-results" style="display: none;">
  <h3>Audio Analysis Results</h3>
  <div id="left-analysis"></div>
  <div id="right-analysis"></div>
</div>

<!-- Div for displaying error messages that aren't exclusively console -->
<div id="error-message" style="color: red; display: none;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Get references to the audio player and its source (for the script portion of page)
  // sets up various params for our single player
  const leftPlayer = document.getElementById('left-player');
  const rightPlayer = document.getElementById('right-player');
  const leftSource = document.getElementById('left-source');
  const rightSource = document.getElementById('right-source');
  const playPauseButton = document.getElementById('play-pause');
  const volumeControl = document.getElementById('volume');
  const currentTimeSpan = document.getElementById('current-time');
  const durationSpan = document.getElementById('duration');
  // Used to display errors in div
  const errorMessage = document.getElementById('error-message');
 
  console.log('**********Initial Left Source URL:', leftSource.src);
  console.log('**********Initial Right Source URL:', rightSource.src);

  // functions for custom single player with two player channels
  // this should help ensure our two audio players stay in synch!
  function checkSync() {
    const timeDifference = Math.abs(leftPlayer.currentTime - rightPlayer.currentTime);
    // If out of sync by more than 100 milliseconds
    if (timeDifference > 0.1) {
      // displays the synch issue amd severity
      console.log('Sync correction needed. Difference:', timeDifference);
      // attempts to correct the issue by setting right to left (left is our master)
      rightPlayer.currentTime = leftPlayer.currentTime;
    }
  }
  // Path is set by helper in form_with above, this is for player
  // This loads the original unadjusted audio file
  function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
  }

  function updateTimeDisplay() {
    currentTimeSpan.textContent = formatTime(leftPlayer.currentTime);
    durationSpan.textContent = formatTime(leftPlayer.duration);
    // runs the check sync function to make sure both files are properly lined up
    checkSync();
  }

  playPauseButton.addEventListener('click', function() {
    console.log('Play button clicked');
    console.log('Left player readyState:', leftPlayer.readyState);
    console.log('Right player readyState:', rightPlayer.readyState);
    if (leftPlayer.paused) {
      // promise should hopefully ensure these both occur at the same time
      Promise.all([leftPlayer.play(), rightPlayer.play()]).then(() => {
        playPauseButton.textContent = 'Pause';
        console.log('Both players are playing');
      }).catch(error => {
        console.error('Error playing audio:', error);
      });
    } else {
      leftPlayer.pause();
      rightPlayer.pause();
      playPauseButton.textContent = 'Play';
      console.log('Both players are paused');
    }
  });

  // debug stugg
  leftPlayer.addEventListener('error', function(e) {
    console.error('Error occurred in left audio player:', e);
  });

  rightPlayer.addEventListener('error', function(e) {
    console.error('Error occurred in right audio player:', e);
  });

  // Sync right player when 'seeking' in left player - left is our master player
  leftPlayer.addEventListener('seeking', function() {
    rightPlayer.currentTime = leftPlayer.currentTime;
  });
  volumeControl.addEventListener('input', function() {
    leftPlayer.volume = this.value;
    rightPlayer.volume = this.value;
  });

  leftPlayer.addEventListener('timeupdate', updateTimeDisplay);
  leftPlayer.addEventListener('loadedmetadata', updateTimeDisplay);
  rightPlayer.addEventListener('loadedmetadata', updateTimeDisplay);

  leftPlayer.addEventListener('loadedmetadata', () => {
    console.log('Left player loaded. Duration:', leftPlayer.duration);
  });

  rightPlayer.addEventListener('loadedmetadata', () => {
    console.log('Right player loaded. Duration:', rightPlayer.duration);
  });

  document.querySelectorAll('.adjust-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      // overrides any default form behavior for ours
      e.preventDefault();
      const formData = new FormData(form);
    });
    // This is an AJAX request for when we want to adjust the audio. Goal is to adjust without page refresh.
    fetch('<%= adjust_audio_files_path %>', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
          console.error('Network response error:', response);
          throw new Error('Network response error');
        }
        return response.json(); 
      })
      .then(data => {
        console.log('Received response data:', data);

        // fetches separate blobs using the URLs provided in the JSON response derived from blob
        const leftFetch = fetch(data.left_url).then(res => res.blob());
        const rightFetch = fetch(data.right_url).then(res => res.blob());

        return Promise.all([leftFetch, rightFetch]);
      })
      // This MUST be blob, not data!! We are workin with audio.
      .then(([leftBlob, rightBlob]) => {
        console.log('Left Blob size:', leftBlob.size);
        console.log('Right Blob size:', rightBlob.size);

        if (leftBlob.size === 0 || rightBlob.size === 0) {
          console.error('One of the blobs is empty. Please check the server response.');
          errorMessage.textContent = 'Error: Empty file received from server.';
          errorMessage.style.display = 'block';
          return;
        }

        const leftUrl = URL.createObjectURL(leftBlob);
        const rightUrl = URL.createObjectURL(rightBlob);

        console.log('New left audio URL:', leftUrl);
        console.log('New right audio URL:', rightUrl);

        // This creates a URL for the adjusted audio files
        console.log('New left audio URL:', leftUrl);
        console.log('New right audio URL:', rightUrl);
        
        // Updates our source audio, player, etc for the new file
        leftPlayer.src = leftUrl;
        rightPlayer.src = rightUrl;

        leftPlayer.load();
        rightPlayer.load();
        console.log('******************Updated left source:', leftSource.src);
        console.log('*****************Updated right source:', rightSource.src);
        console.log('Left player duration:', leftPlayer.duration);
        console.log('Right player duration:', rightPlayer.duration);
        console.log('Left player readyState:', leftPlayer.readyState);
        console.log('Right player readyState:', rightPlayer.readyState);
        console.log('Audio players reloaded with separate blobs.');
        console.log('Audio players reloaded.');
        
        // Hide any previous error message
        // TODO: Make sure this isn't screwing up ever displaying
        errorMessage.style.display = 'none';
      })
      .catch(error => {
        console.error('Error:', error);
        errorMessage.textContent = 'An error occurred while adjusting the audio.';
        errorMessage.style.display = 'block';
    });
  });
});
</script>